{% load static %}

<div id="game-container">
    
    <div id="players">
        <div id='player1-username-top'>
            <img src="" alt="" id="player1-av">
            <div id="player1-user-name"></div>
        </div>
        <div id='score'></div>
        <div id='player2-username-top'>
            <img src="" alt="" id="player2-av">
            <div id="player2-user-name"></div>
        </div>
    </div>

    <canvas id="gameCanvas" width="1000" height="600"></canvas>

    <!-- Modal for waiting or enemy found status -->
    <div id="waiting-modal" class="unique-modal-overlay">
        <div class="unique-modal-content">
            <div class="unique-player-info" id="player1-info">
                <img src="" id="player1-avatar" class="unique-avatar" alt="">
                <div class="unique-username" id="player1-username"></div>
                <div class="unique-elo-container">
                    <img src="{% static 'trophy.jpg'%}" id="player1-trophy" class="unique-icon" alt="Trophy Icon">
                    <span id="player1-elo" class="unique-elo"></span>
                </div>
            </div>
            <div class="unique-middle-content" id="loading-text">
                <p id="waiting-text">Searching for other player</p>
                <button id="cancel-button" class="unique-cancel-button">Cancel</button>
                <img src="{% static 'swords.jpg' %}" id="swords-icon" class="unique-icon" style="display: none;" alt="Swords Icon">
                <img src="{% static 'time.png'%}" alt="" id="time-picture">
            </div>
            <div class="unique-player-info" id="player2-info" style="display: none;">
                <img src="{}" id="player2-avatar" class="unique-avatar" alt="">
                <div class="unique-username" id="player2-username"></div>
                <div class="unique-elo-container">
                    <img src="{% static 'trophy.jpg'%}" id="player2-trophy" class="unique-icon" alt="Trophy Icon">
                    <span id="player2-elo" class="unique-elo"></span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    sessionId = "{{ session_id }}";
    socket1 = new WebSocket(`wss://${window.location.host}/wss/game/${sessionId}/`);
    lastStatus = ""; // To track the last status
    init();

    socket1.onmessage = function(event) {
        const data = JSON.parse(event.data);

        updateGameCanvas(data);
        // Only update modal when status changes
        if (lastStatus !== data.status) {
            handleStatus(data);
            lastStatus = data.status; // Update the lastStatus with current status
        }
        else if (lastStatus === "Paused")
        {
            const loadingText = document.getElementById('loading-text');
            const waitingText = document.getElementById('waiting-text');
            waitingText.style.display = 'flex';
            console.log(data.paused, data.current_player);
            let textForPause = 'You can unpause';
            if (data.current_player != data.paused)
            {
                if (data.time >= 0)
                {
                    textForPause += ' in ' + data.time + ' seconds';
                }
            }
            waitingText.textContent = textForPause;
        }
        else if (lastStatus==='Playing')
        {
            const score = document.getElementById('score');
            score.textContent = data.score1 + ":" data.score2;
        }
    };

    function handleStatus(data) {
        const modal = document.getElementById('waiting-modal');
        const player2Info = document.getElementById('player2-info');
        const loadingText = document.getElementById('loading-text');
        const cancelButton = document.getElementById('cancel-button');
        const waitingText = document.getElementById('waiting-text');
        const swordsIcon = document.getElementById('swords-icon');
        const timePic = document.getElementById('time-picture');
        if (data.status === 'Waiting for other player') {
            modal.style.display = 'flex'; // Show the modal
            player2Info.style.display = 'flex'; // Hide player 2 info
            loadingText.style.display = 'flex'; // Show loading text
            waitingText.style.display = 'block'; // Show waiting text
            cancelButton.style.display = 'block'; // Show cancel button
            swordsIcon.style.display = 'none'; // Hide swords icon
            timePic.style.display = 'none';

            document.getElementById('player1-avatar').src = data.player1.avatar;
            document.getElementById('player1-username').textContent = data.player1.username;
            document.getElementById('player1-elo').textContent = data.player1.elo;

            // Show the cancel button and waiting text only when waiting for other player
            cancelButton.style.display = 'block';
            cancelButton.onclick = function() {
                socket1.close();
                window.location.href = "/"; // Redirect to the home page or any appropriate action
            };

        } else if (data.status === 'enemy_found') {
            modal.style.display = 'flex'; // Show the modal
            player2Info.style.display = 'flex'; // Show player 2 info
            loadingText.style.display = 'flex'; // Show loading text
            waitingText.style.display = 'none'; // Hide waiting text
            swordsIcon.style.display = 'block'; // Show swords icon
            timePic.style.display = 'none';

            document.getElementById('player1-avatar').src = data.player1.avatar;
            document.getElementById('player1-username').textContent = data.player1.username;
            document.getElementById('player1-elo').textContent = data.player1.elo;
            document.getElementById('player2-avatar').src = data.player2.avatar;
            document.getElementById('player2-username').textContent = data.player2.username;
            document.getElementById('player2-elo').textContent = data.player2.elo;

            cancelButton.style.display = 'none'; // Hide the cancel button when enemy is found
        }
        else if (data.status == 'Paused')
        {
            modal.style.display = 'flex'; 
            player2Info.style.display = 'flex'; 
            loadingText.style.display = 'flex'; 
            waitingText.style.display = 'none'; 
            cancelButton.style.display = 'none';
            timePic.style.display = 'block';

            swordsIcon.scr = "/static/time.png"
            document.getElementById('player1-avatar').src = data.player1.avatar;
            document.getElementById('player1-username').textContent = data.player1.username;
            document.getElementById('player1-elo').textContent = data.player1.elo;
            document.getElementById('player2-avatar').src = data.player2.avatar;
            document.getElementById('player2-username').textContent = data.player2.username;
            document.getElementById('player2-elo').textContent = data.player2.elo;
        } 
        else {
            modal.style.display = 'none';
            const player1 = document.getElementById('player1-user-name');
            const player2 = document.getElementById('player2-user-name');
            player1.textContent = data.player1.username;
            player2.textContent = data.player2.username;
            const image1 = document.getElementById('player1-av');
            const image2 = document.getElementById('player2-av');
            image1.src = data.player1.avatar;
            image2.src = data.player2.avatar;
        }
    }

    function updateGameCanvas(data) {
        animate(data.posx, data.posy, data.pos1, data.pos2);
    }

    document.addEventListener('keydown', function(event) {
        let key = event.key;

        if ((key == 'f' || key == 'F' || key == 'v' || key == 'V') && event.repeat) {
            return;
        }
        if (key == 'v' || key == 'V') {
            cameraView += 1;
            cameraView %= 3;
            return;
        }

        if (
            (key == 'w' ||
                key == 'W' ||
                key == 'ArrowUp' ||
                key == 'ArrowDown' ||
                key == 's' ||
                key == 'S') &&
            cameraView != 0
        )
            return;
        if (
            (key == 'a' ||
                key == 'A' ||
                key == 'ArrowLeft' ||
                key == 'ArrowRight' ||
                key == 'd' ||
                key == 'D') &&
            cameraView == 0
        ) {
            return;
        } else {
            if (cameraView == 1) {
                if (key == 'a' || key == 'A') key = 's';
                else if (key == 'ArrowLeft') key = 'ArrowDown';
                else if (key == 'd' || key == 'D') key = 'w';
                else if (key == 'ArrowRight') key = 'ArrowUp';
            } else {
                if (key == 'a' || key == 'A') key = 'w';
                else if (key == 'ArrowLeft') key = 'ArrowUp';
                else if (key == 'd' || key == 'D') key = 's';
                else if (key == 'ArrowRight') key = 'ArrowDown';
            }
        }
        const message = {
            type: 'keydown',
            key: key,
        };
        socket1.send(JSON.stringify(message));
    });
</script>

<style>
    #game-container {
        text-align: center;
        margin-top: 20px;
    }

    canvas {
        border: 1px solid black;
        background: #eee;
        display: block;
        margin: 0 auto;
    }

    .unique-modal-overlay {
        display: none; /* Hidden by default */
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        justify-content: center;
        align-items: center;
        z-index: 2000; /* Higher priority */
    }

    .unique-modal-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 80%; /* Increased size */
        max-width: 1200px; /* Max size constraint */
        background-color: white;
        padding: 40px; /* Increased padding for a bigger look */
        border-radius: 12px;
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        z-index: 3000; /* Higher priority for modal content */
    }

    .unique-player-info {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        width: 30%; /* Increased player info size */
    }

    .unique-avatar {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        margin-bottom: 15px;
    }

    .unique-username {
        font-weight: bold;
        margin-bottom: 10px;
        color: #333;
    }

    .unique-elo-container {
        display: flex;
        justify-content: center;
        align-items: center;  
        margin-top: 10px; /* Adjust spacing as needed */
    }

    .unique-elo {
        margin-top:20px;
        font-size: 32px;
        color: #777;
        margin-left: 10px; /* Space between Elo and trophy */
    }

    .unique-middle-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-size: 20px; /* Increased font size */
        color: #333;
        flex-grow: 1;
    }

    .unique-cancel-button {
        margin-top: 20px;
        padding: 10px 20px;
        font-size: 16px;
        background-color: #ff4c4c;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }

    .unique-cancel-button:hover {
        background-color: #ff2c2c;
    }

    .unique-icon {
        width: 50px;
        height: 50px;
        margin-top: 20px;
    }

    #swords-icon{
        width: 150px;
        height: 150px;
    }

    #time-picture{
        width: 150px;
        height: 150px   ;
    }

    #players {
        display: flex;
        justify-content:
        align-items:
        width: 100%;
        max-width: 1000px;
        margin: 0 auto;
        padding: 10px 20px;
        box-sizing: border-box;
        z-index: 10000;
    }
    
    #player1-username-top,
    #player2-username-top {
        flex: 1;
        text-align: center; 
    }
    
    #score {
        flex: 2;
        text-align: center; 
        font-size: 24px; 
        font-weight: bold; 
    }

</style>
