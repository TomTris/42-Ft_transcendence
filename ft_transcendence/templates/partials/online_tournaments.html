<style>
    #status {
        font-size: 24px;
        color: #333;
        text-align: center;
        margin-top: 20px;
    }
    #players {
        font-size: 20px;
        color: #555;
        text-align: center;
        margin-top: 30px;
    }
    .kick-button, #finish-button, #quit-button, #start-button, #redirect-button {
        margin-left: 10px;
        padding: 5px 10px;
        color: white;
        border: none;
        cursor: pointer;
    }
    .kick-button {
        background-color: #d9534f;
    }
    #finish-button, #start-button {
        margin-top: 20px;
        background-color: #5cb85c;
    }
    #quit-button {
        margin-top: 20px;
        background-color: #f0ad4e;
    }
    #redirect-button {
        background-color: #0275d8;
        margin-top: 20px;
    }
    #timer {
        font-size: 28px;
        color: #d9534f;
        text-align: center;
        margin-top: 20px;
    }
    /* Pop-up styles */
    .popup {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .popup-content {
        background: #fff;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        width: 300px;
        max-width: 80%;
    }
    .popup-content button {
        margin-top: 20px;
        padding: 10px 20px;
        background: #007BFF;
        color: #fff;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
    }
    .popup-content button:hover {
        background: #0056b3;
    }
    .hidden {
        display: none;
    }
</style>
<div id="status">Connecting...</div>
<div id='code'></div>
<div id="players"></div>
<div id="actions"></div>
<div id="timer" class="hidden">60</div> <!-- Timer display -->

<!-- Pop-up structure -->
<div id="notification-popup" class="popup hidden">
    <div class="popup-content">
        <h2 id="popup-title">Notification</h2>
        <p id="popup-message">You have been notified.</p>
        <button onclick="redirectToHome()">Go to Home</button>
    </div>
</div>

<script>
    sessionId = "{{ session_id }}";
    socket1 = new WebSocket(`wss://${window.location.host}/wss/game/tournament/${sessionId}/`);

    statusDiv = document.getElementById('status');
    playersDiv = document.getElementById('players');
    actionsDiv = document.getElementById('actions');
    codeDiv = document.getElementById('code');
    timerDiv = document.getElementById('timer');
    notificationPopup = document.getElementById('notification-popup');
    popupTitle = document.getElementById('popup-title');
    popupMessage = document.getElementById('popup-message');
    countdownInterval;
    countdownTime = 60;
    

    {% comment %} socket1.onopen = function() {
    }; {% endcomment %}

    socket1.onmessage = function(event) {
        const data = JSON.parse(event.data);
        codeDiv.innerHTML = data.code;
    
        // Handle pop-up for Kick or Cancel statuses
        if (data.status === 'Kick' || data.status === 'Cancel') {
            popupTitle.textContent = data.status === 'Kick' ? 'You Were Kicked Out!' : 'Tournament Cancelled';
            popupMessage.textContent = data.status === 'Kick' ? 'Sorry, you have been kicked out of the game.' : 'The tournament has been cancelled.';
            notificationPopup.classList.remove('hidden');
            socket.close();
            return;
        }
    
        // Update the status
        statusDiv.textContent = 'Status: ' + data.status;
    
        // Always display the player list
        playersDiv.innerHTML = `
            <p>Player 1: ${data.player1 ? data.player1.username : 'Waiting...'}</p>
            <p>Player 2: ${data.player2 ? data.player2.username : 'Waiting...'} ${data.player === 1 && data.player2 && data.player1.id !== data.player2.id && (data.status === 'Waiting' || data.status === 'Confirming') ? '<button class="kick-button" onclick="kickPlayer(2)">Kick</button>' : ''}</p>
            <p>Player 3: ${data.player3 ? data.player3.username : 'Waiting...'} ${data.player === 1 && data.player3 && data.player1.id !== data.player3.id && (data.status === 'Waiting' || data.status === 'Confirming') ? '<button class="kick-button" onclick="kickPlayer(3)">Kick</button>' : ''}</p>
            <p>Player 4: ${data.player4 ? data.player4.username : 'Waiting...'} ${data.player === 1 && data.player4 && data.player1.id !== data.player4.id && (data.status === 'Waiting' || data.status === 'Confirming') ? '<button class="kick-button" onclick="kickPlayer(4)">Kick</button>' : ''}</p>
        `;
    
        // Only show action buttons when the status is "Waiting" or "Confirming"
        if (data.status === 'Waiting' || data.status === 'Confirming') {
            if (data.player === 1) {
                actionsDiv.innerHTML = `
                    ${data.status === 'Confirming' ? '<button id="start-button" onclick="startGame()">Start</button>' : ''}
                    <button id="finish-button" onclick="finishLobby()">Finish</button>
                `;
            } else {
                actionsDiv.innerHTML = `<button id="quit-button" onclick="quitGame(${data.player})">Quit</button>`;
            }
        } else if (data.status === 'Round1') {
            // Handle redirect buttons based on finished status
            if ((data.player === 1 || data.player === 2) && data.finished1 === 0) {
                actionsDiv.innerHTML = `<button id="redirect-button" onclick="redirectToGame('${data.game1_id}')">Join Game</button>`;
            } else if ((data.player === 1 || data.player === 2) && data.finished1 !== 0) {
                actionsDiv.innerHTML = `<p>Waiting for other match to finish...</p>`;
            } else if ((data.player === 3 || data.player === 4) && data.finished2 === 0) {
                actionsDiv.innerHTML = `<button id="redirect-button" onclick="redirectToGame('${data.game2_id}')">Join Game</button>`;
            } else if ((data.player === 3 || data.player === 4) && data.finished2 !== 0) {
                actionsDiv.innerHTML = `<p>Waiting for other match to finish...</p>`;
            }
        } else if (data.status === 'Round2_count') {
            // Start the countdown for Round2_count
            startCountdown();
        } else if (data.status === 'Round2') {
            // Handle Round2 status
            if (data.player === data.final1 || data.player === data.final2) {
                actionsDiv.innerHTML = `<button id="redirect-button" onclick="redirectToGame('${data.game3_id}')">Join Final Game</button>`;
            } else {
                actionsDiv.innerHTML = `<p>You are out. Wait till you see the result of the tournament.</p>`;
            }
        } else {
            actionsDiv.innerHTML = ''; // Clear actions if status is not waiting, confirming, round1, round2, or counting statuses
            stopCountdown(); // Stop the countdown if the status is not counting
        }
    
        // Handle the timer for Round1_count and Round2_count statuses
        if (data.status === 'Round1_count' || data.status === 'Round2_count') {
            startCountdown();
        } else {
            stopCountdown();
        }
    };
    

    socket1.onerror = function(error) {
        console.error('WebSocket error:', error);
        statusDiv.textContent = 'Error connecting to the server.';
    };

    socket1.onclose = function() {
        statusDiv.textContent = 'Disconnected from server.';
        stopCountdown(); // Stop the countdown when the socket closes
    };

    
    
    function startCountdown() {
        clearInterval(countdownInterval); // Clear any existing countdown
        countdownTime = 60; // Reset countdown to 60
        statusDiv.textContent = `Countdown: ${countdownTime}`;
    
        countdownInterval = setInterval(function() {
            countdownTime--;
            statusDiv.textContent = `Countdown: ${countdownTime}`;
    
            if (countdownTime <= 0) {
                clearInterval(countdownInterval);
                statusDiv.textContent = 'Time is up!';
            }
        }, 1000);
    }
    
    function stopCountdown() {
        clearInterval(countdownInterval); // Clear the countdown interval
    }
    

    // Function to kick a player
    window.kickPlayer = function(playerNumber) {
        const kickMessage = {
            type: 'kick',
            player: playerNumber
        };
        socket1.send(JSON.stringify(kickMessage));
    };

    // Function to finish the lobby
    window.finishLobby = function() {
        const finishMessage = {
            type: 'cancel'
        };
        socket1.send(JSON.stringify(finishMessage));
    };

    // Function to quit the game
    window.quitGame = function(player) {
        const quitMessage = {
            type: 'quit',
            player: player
        };
        socket1.send(JSON.stringify(quitMessage));
        redirectToHome();
    };

    // Function to start the game
    window.startGame = function() {
        const startMessage = {
            type: 'start'
        };
        socket1.send(JSON.stringify(startMessage));
    };

    // Function to redirect to the game page
    window.redirectToGame = function(gameId) {
        link = `/game/${gameId}`;
        loadContent(link, defaultOption, true);
    };

    // Function to redirect to home page
    window.redirectToHome = function() {
        loadContent('/', defaultOption, true);
    };
</script>